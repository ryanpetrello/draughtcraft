<%inherit file="../../layout.html" />

<%def name="title()">
  ${recipe.name}
  % if recipe.author:
    - ${recipe.author.username}
  % endif
</%def>

<%def name="style()">
    ${h.css('/css/recipes/builder.css')}
    <link rel="stylesheet" type="text/css" media="print" href="${h.stamp('/css/recipes/builder.print.css')}" />
</%def>

<%def name="javascript()">
  <script type="text/javascript">

    (function(ns, $){
      ns.recipes = ns.recipes || {}, ns.recipes.builder = ns.recipes.builder || {};
      ns.recipes.builder.STYLES = [
      % for s in h.model.Style.query.order_by(h.model.Style.name).all():
        {"id": ${s.id}, "name": "${s.name}"},
      % endfor
      ];
      
    })($.draughtcraft = $.draughtcraft || {}, $);

  </script>
  <script type="text/javascript" src="/javascript/knockout-2.1.0.js"></script>
  <script type="text/javascript" src="/javascript/recipes/builder.js"></script>
</%def>

<div id="builder" data-bind="with: recipe">

  <div id="header">

    <h1>
      <input data-bind="value: name" type="text" class_="name" />
    </h1>
    % if recipe.copied_from:
      <span class="copied_from">
        based on 
        <a href="${recipe.copied_from.url()}">${recipe.copied_from.author.username}'s recipe</a>
      </span>
    % endif

    <fieldset>
      <select
        data-bind="options: $root.styles, value: style, optionsText: 'name', optionsValue: 'id'">
      </select>
    </fieldset>

    <fieldset>
      <input data-bind="value: volume" type="text" class="unit" />
      ${'L.' if recipe.metric else 'Gal.'}
    </fieldset>

    % if recipe.author:
      <p class="author">
        By: ${recipe.author.full_name.strip() or recipe.author.username}
      </p>
      <a href="/profile/${recipe.author.username}" class="author">
        <img
          src="${recipe.author.gravatar}&s=45"
          class="gravatar"
          title="${recipe.author.username}"
        />
      </a>
      <img
        src="${recipe.author.gravatar}&s=100"
        class="gravatar fullsize"
        title="${recipe.author.username}"
      />
    % endif

  </div>

  <div id="builder-ajax">
    <div class="builder-loading">
      <img src="/images/loading.gif" /> 
    </div>

    <div class="step clearfix active">
      <h2>
        <ul>
          <li class="active"><a href="#mash">Mash</a></li>
          <li><a href="#boil">Boil</a></li>
          <li class="last"><a href="#ferment">Ferment</a></li>
        </ul>
      </h2>

      <div class="ingredient-list">
        <h3 class="ribbon">
          Ingredients
        </h3>

        <table>
          <tbody>
            <tr>
              <th class="type"></th>
              <th class="percent">%</th>
              <th class="amount">Amount</th>
              <th>Fermentable</th>
              <th>PPG</th>
              <th class="unit">L</th>
              <th class="close"></th>
            </tr>
          </tbody>
          <tbody data-bind="foreach: mash">
            <tr data-bind="css: { 'even': ($index() % 2 == 0) }" id="xyz" class="addition">
              <td data-bind="with: ingredient" class="type grain">
                <span data-bind="text: printed_type"></span>
              </td>
              <td class="percent">
                XYZ%
              </td>
              <td class="amount">
                <input data-bind="value: amount + ' ' + unit" type="text" />
              </td>
              <td data-bind="with: ingredient">
                <a data-bind="text: name, attr: {href: '/ingredients/' + id}" tabindex="9999"></a>
              </td>
              <td data-bind="with: ingredient">
                <span data-bind="text: ppg"></span>
              </td>
              <td class="unit" data-bind="with: ingredient">
                <span data-bind="text: lovibond"></span>
              </td>
              <td class="close">
                <a href="#" tabindex="9999">
                  <img src="/images/close.png">
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>

  </div>

  <div id="builder-buttons">
    % if recipe.author:
      ${h.form('publish')}
        <button class="publish-btn">Publish Changes</button>
        <span class="sep">or</span> <a href="/profile/${recipe.author.username}">Cancel</a>
      ${h.end_form()}
    % else:
      ${h.form('/signup', method='GET')}
        <button>Save Changes</button>
      ${h.end_form()}
    % endif
  </div>
</div>
