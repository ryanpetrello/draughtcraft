<%inherit file="../../layout.html" />

<%def name="title()">
  ${recipe.name}
  % if recipe.author:
    - ${recipe.author.username}
  % endif
</%def>

<%def name="style()">
    ${h.css('/css/recipes/builder.css')}
    ${h.css('/css/jquery.selectbox.css')}
    <link rel="stylesheet" type="text/css" media="print" href="${h.stamp('/css/recipes/builder.print.css')}" />
</%def>

<%def name="javascript()">
  <script type="text/javascript">

    (function(ns, $){
      ns.recipes = ns.recipes || {}, ns.recipes.builder = ns.recipes.builder || {};
      ns.recipes.builder.STYLES = [
      % for s in h.model.Style.query.order_by(h.model.Style.name).all():
        {"id": ${s.id}, "name": "${s.name}"},
      % endfor
      ];
      
    })($.draughtcraft = $.draughtcraft || {}, $);

  </script>
  ${h.js('/javascript/jquery.selectbox.min.js')}
  <script type="text/javascript" src="/javascript/knockout.min.js"></script>
  <script type="text/javascript" src="/javascript/recipes/builder.js"></script>
  <script type="text/javascript" src="/javascript/recipes/units.js"></script>
</%def>

<div id="builder" data-bind="with: recipe">

  <div id="header">

    <h1>
      <input data-bind="value: name" type="text" class_="name" />
    </h1>
    % if recipe.copied_from:
      <span class="copied_from">
        based on 
        <a href="${recipe.copied_from.url()}">${recipe.copied_from.author.username}'s recipe</a>
      </span>
    % endif

    <fieldset>
      <select
        data-bind="options: $root.STYLES, value: style, optionsText: 'name', optionsValue: 'id'">
      </select>
    </fieldset>

    <fieldset>
      <input data-bind="value: volume" type="text" class="unit" />
      ${'L.' if recipe.metric else 'Gal.'}
    </fieldset>

    % if recipe.author:
      <p class="author">
        By: ${recipe.author.full_name.strip() or recipe.author.username}
      </p>
      <a href="/profile/${recipe.author.username}" class="author">
        <img
          src="${recipe.author.gravatar}&s=45"
          class="gravatar"
          title="${recipe.author.username}"
        />
      </a>
      <img
        src="${recipe.author.gravatar}&s=100"
        class="gravatar fullsize"
        title="${recipe.author.username}"
      />
    % endif

  </div>

  <div id="builder-ajax">

    <div class="builder-loading">
      <img src="/images/loading.gif" /> 
    </div>

    <%def name="li(name, active=False, last=False)">
      <%
        cls = 'active' if active else ''
        if last:
          cls += ' last'
      %>
      <li class="${cls}">
        <a data-bind="click: function(d, e) { $root.activateStep('${name}', d, e) }" href="#">${name.capitalize()}</a>
      </li>
    </%def>

    <%def name="step(name)">
      <div class="step clearfix ${name}">

        <h2>
          <ul>
            ${li('mash', name == 'mash')}
            ${li('boil', name == 'boil')}
            ${li('ferment', name == 'ferment', True)}
          </ul>
        </h2>

        <div class="ingredient-list">
          <h3 class="ribbon">
            Ingredients
          </h3>

          <%include file="steps/${name}.html"/>
        </div>

        <div class="inventory ${name}">
          ${caller.inventory()}
        </div>

      </div>
    </%def>

    <%self:step name="mash">
      <%def name="inventory()">
        <h3>Add to Mash</h3>

        <fieldset>
          <select
            data-bind="options: inventory().malts, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Malt/Fermentables...'">
          </select>
        </fieldset>

        <fieldset>
          <select
            data-bind="options: inventory().extracts, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Malt Extract...'">
          </select>
        </fieldset>

        <fieldset>
          <select
            data-bind="options: inventory().hops, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Hops...'">
          </select>
        </fieldset>

        <fieldset>
          <select
            data-bind="options: inventory().extras, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Misc...'">
          </select>
        </fieldset>
      </%def>
    </%self:step>

    <%self:step name="boil">
      <%def name="inventory()">
        <h3>Add to Boil</h3>

        <fieldset>
          <select
            data-bind="options: inventory().malts, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Malt/Fermentables...'">
          </select>
        </fieldset>

        <fieldset>
          <select
            data-bind="options: inventory().extracts, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Malt Extract...'">
          </select>
        </fieldset>

        <fieldset>
          <select
            data-bind="options: inventory().hops, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Hops...'">
          </select>
        </fieldset>

        <fieldset>
          <select
            data-bind="options: inventory().extras, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Misc...'">
          </select>
        </fieldset>
      </%def>
    </%self:step>

    <%self:step name="ferment">
      <%def name="inventory()">
        <h3>Add to Fermenter</h3>

        <fieldset>
          <select
            data-bind="options: inventory().yeast, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Yeast...'">
          </select>
        </fieldset>

        <fieldset>
          <select
            data-bind="options: inventory().hops, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Dry Hops...'">
          </select>
        </fieldset>

        <fieldset>
          <select
            data-bind="options: inventory().extras, optionsText: 'name', optionsValue: 'id', optionsCaption: 'Add Misc...'">
          </select>
        </fieldset>
      </%def>
    </%self:step>

  </div>

  <div id="builder-buttons">
    % if recipe.author:
      ${h.form('publish')}
        <button class="publish-btn">Publish Changes</button>
        <span class="sep">or</span> <a href="/profile/${recipe.author.username}">Cancel</a>
      ${h.end_form()}
    % else:
      ${h.form('/signup', method='GET')}
        <button>Save Changes</button>
      ${h.end_form()}
    % endif
  </div>
</div>
